name: Sync Pipelineruns

on:
  workflow_dispatch:
    inputs:
      dry_run:
        type: boolean
        description: 'Dry Run (No changes are committed)'
        required: true
        default: false
      release_branch:
        description: 'Release branch to sync PipelineRuns to'
        default: "rhoai-x.y"
        required: true
      repository:
        type: choice
        description: Select repository for syncing pipelineruns
        options:
          - all
          - RHOAI-Build-Config
          - argo-workflows
          - caikit-nlp
          - codeflare-operator
          - data-science-pipelines
          - data-science-pipelines-operator
          - feast
          - fms-guardrails-orchestrator
          - guardrails-regex-detector
          - ilab-on-ocp
          - kserve
          - kubeflow
          - kuberay
          - kueue
          - lm-evaluation-harness
          - ml-metadata
          - model-registry
          - model-registry-operator
          - modelmesh
          - modelmesh-runtime-adapter
          - modelmesh-serving
          - must-gather
          - odh-dashboard
          - odh-model-controller
          - rest-proxy
          - rhods-operator
          - training-operator
          - trustyai-explainability
          - trustyai-service-operator
          - vllm
          - vllm-gaudi
          - vllm-orchestrator-gateway

env:
  PIPELINERUNS_DIR: "pipelineruns"
  SYNC_CONFIG_FILE: "sync-config.yaml"
  GITHUB_ORG: "red-hat-data-services"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.config }}
    steps:
      - name: Validate release_branch format
        run: |
          if [[ ! "${{ github.event.inputs.release_branch }}" =~ ^rhoai-[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid release_branch format: '${{ github.event.inputs.release_branch }}'"
            echo "Expected format: rhoai-x.y (e.g., rhoai-2.20)"
            exit 1
          fi

      - name: Checkout code - main
        uses: actions/checkout@v3

      - name: Checkout code - ${{ github.event.inputs.release_branch }}
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.release_branch }}
          path: ${{ github.event.inputs.release_branch }}


      - name: Print Debug Info
        run: |
          ls -R

      - name: Set up Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruyaml

      - name: Generate ${{ env.SYNC_CONFIG_FILE }}
        run: |
          python script/generate_pipelinerun_sync_config.py --pipelinerun-dir "${{ github.event.inputs.release_branch }}/${{ env.PIPELINERUNS_DIR }}" --output ${{ env.SYNC_CONFIG_FILE }} --github-org ${{ env.GITHUB_ORG }} 
          cat ${{ env.SYNC_CONFIG_FILE }}

      - name: Generate Matrix Config
        id: matrix
        run: |
          config=$(yq -o json ${{ env.SYNC_CONFIG_FILE }} | jq -c '.')

          if ([[ "${{ github.event_name  }}" == "workflow_dispatch" ]] && [[ "${{ github.event.inputs.repository }}" != "all" ]])
          then
            config=$(echo $config | jq -c 'map(select(.["repo"] == "${{ env.GITHUB_ORG }}/${{ github.event.inputs.repository }}"))')
          fi

          echo "config=${config}"
          length=$(echo $config | jq '. | length')
          echo "$length repo(s) will be syned by this workflow"
          if [[ $length -eq 0 ]]
          then 
            echo "No valid repos available for the sync"
            exit 1
          fi
          
          echo "$config" | jq .
          echo "config=$config" >> $GITHUB_OUTPUT

  sync:
    needs: [setup]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJSON(needs.setup.outputs.matrix) }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: configure git committer string
        run: |
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com>'

      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.release_branch }}
          path: source

      - name: Checkout ${{ matrix.config.repo }}
        uses: actions/checkout@v3
        with:
          repository: ${{ matrix.config.repo }}
          token: ${{ steps.app-token.outputs.token }}
          ref: ${{ github.event.inputs.release_branch }}
          path: target

      - name: Print Debug Info
        run: |
          ls -lart
          ls -lart source/${{ env.PIPELINERUNS_DIR }}
          ls -lart target

      - name: Sync Pipelineruns
        run: |
          repo_name=$(basename "${{ matrix.config.repo }}")
          cp -rf "source/${{ env.PIPELINERUNS_DIR }}/${repo_name}/.tekton/"* "target/.tekton"

      - name: Commit Changes
        run: |
          cd source
          konflux_central_commit=$(git rev-parse --short HEAD)

          cd ../target

          set -x
          git status
          git add -f .tekton
          git diff --staged
          set +x

          # Check if there are any changes to commit
          if git diff --staged --quiet; then
            echo "Pipelineruns are already in sync. No changes to commit."
          else
            git commit -m "sync pipelineruns with konflux-central - ${konflux_central_commit}"
          fi

          # Check if dry_run is false and push changes if true
          if [[ "${{ github.event.inputs.dry_run }}" == 'false' ]]; then
            git push origin ${{ github.event.inputs.release_branch }}
          else
            echo "'dry_run' is enabled. No changes will be pushed."
          fi

      # - name: Slack Notification
      #   if: ${{ failure() }}
      #   uses: rtCamp/action-slack-notify@v2
      #   env:
      #     SLACK_MESSAGE: ':red-warning: Renovate Synchronization Failed for repo: ${{ matrix.config.repo }}!'
      #     SLACK_WEBHOOK: ${{ secrets.RHOAI_DEVOPS_SLACK_WEBHOOK }}
